version: '3.8'

services:
  db:
    image: mysql:8
    container_name: shopishop_db
    environment:
      MYSQL_DATABASE: ShopiShop1
      MYSQL_ROOT_PASSWORD: 12345
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.backend
    container_name: shopishop_backend
    depends_on:
      - db
    ports:
      - "8080:8080"   # HTTP port
      - "8443:8443"   # HTTPS port
    environment:
      SPRING_DATASOURCE_URL: "jdbc:mysql://db:3306/ShopiShop1"
      SPRING_DATASOURCE_USERNAME: "root"
      SPRING_DATASOURCE_PASSWORD: "12345"
      SPRING_PROFILES_ACTIVE: "prod"
      SERVER_SSL_KEYSTORE: "/app/keystore.jks"  # Path to the keystore inside the container
      SERVER_SSL_KEYSTORE_PASSWORD: "123456"    # Password for the keystore
      SERVER_SSL_KEYSTORE_TYPE: "JKS"           # Keystore type
      # Uncomment and replace with your real mail settings if desired
      # SPRING_MAIL_HOST: "smtp.gmail.com"
      # SPRING_MAIL_PORT: "587"
      # SPRING_MAIL_USERNAME: "some-email@gmail.com"
      # SPRING_MAIL_PASSWORD: "some-app-password"
      SERVER_SSL_ENABLED: "true"
      SERVER_SSL_KEY_STORE: "/app/keystore.p12"  # Changed to .p12 format
      SERVER_SSL_KEY_STORE_PASSWORD: "123456"
      SERVER_SSL_KEY_STORE_TYPE: "PKCS12"  # Changed to match .p12 format
    volumes:
      - ./backend/keystore.jks:/app/keystore.jks  # Mount the keystore file

volumes:
  db_data:



# version: '3.8'

# services:
#   db:
#     image: mysql:8
#     container_name: shopishop_db
#     environment:
#       MYSQL_DATABASE: ShopiShop1
#       MYSQL_ROOT_PASSWORD: 12345
#       MYSQL_USER: shopiuser  # Added dedicated user (recommended)
#       MYSQL_PASSWORD: 12345  # Same as root for simplicity (change in production)
#     ports:
#       - "3306:3306"
#     volumes:
#       - db_data:/var/lib/mysql
#     healthcheck:  # Added health check
#       test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
#       interval: 5s
#       timeout: 10s
#       retries: 5

#   backend:
#     build:
#       context: ./backend
#       dockerfile: Dockerfile.backend
#     container_name: shopishop_backend
#     depends_on:
#       db:
#         condition: service_healthy
#     ports:
#       - "8080:8080"  # HTTP
#       - "8443:8443"  # HTTPS
#     environment:
#       SPRING_DATASOURCE_URL: "jdbc:mysql://db:3306/ShopiShop1?useSSL=false&allowPublicKeyRetrieval=true"
#       SPRING_DATASOURCE_USERNAME: "shopiuser"  # Using dedicated user
#       SPRING_DATASOURCE_PASSWORD: "12345"
#       SPRING_JPA_HIBERNATE_DDL_AUTO: "update"
#       SPRING_PROFILES_ACTIVE: "prod"
      
#       # SSL Configuration
#       SERVER_SSL_ENABLED: "true"
#       SERVER_SSL_KEY_STORE: "/app/keystore.p12"  # Changed to .p12 format
#       SERVER_SSL_KEY_STORE_PASSWORD: "123456"
#       SERVER_SSL_KEY_STORE_TYPE: "PKCS12"  # Changed to match .p12 format
      
#       # HTTP to HTTPS redirect
#       SERVER_HTTP_PORT: "8080"
#       SERVER_HTTP_REDIRECT_PORT: "8443"
      
#       # Optional mail settings (uncomment if needed)
#       # SPRING_MAIL_HOST: "smtp.gmail.com"
#       # SPRING_MAIL_PORT: "587"
#       # SPRING_MAIL_USERNAME: "your-email@gmail.com"
#       # SPRING_MAIL_PASSWORD: "your-app-password"
#       # SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "true"
#       # SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "true"
      
#     volumes:
#       - ./backend/src/main/resources/keystore.p12:/app/keystore.p12:ro
#     restart: unless-stopped
#     healthcheck:  # Added health check
#       test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
#       interval: 30s
#       timeout: 10s
#       retries: 3

# volumes:
#   db_data: